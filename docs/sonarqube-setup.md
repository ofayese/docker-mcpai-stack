# SonarQube Analysis Setup

This repository is configured for both offline (local SonarQube) and online (SonarCloud) code analysis.

## üìä Quick Start

### Offline Analysis (Local SonarQube)

```bash
# Run analysis against local SonarQube server
make sonar-offline
```

### Online Analysis (SonarCloud via GitHub)

```bash
# Trigger SonarCloud analysis via GitHub Actions
make sonar-online
```

### Get Help

```bash
# Show all SonarQube options
make sonar-help
```

## üè† Offline Setup (Local SonarQube)

### Prerequisites

1. **SonarQube Server**: Running on `http://localhost:9000`
2. **Docker**: For running the scanner
3. **Authentication Token**: Set in `sonar-project.local.properties`

### Configuration

- **File**: `sonar-project.local.properties`
- **Host URL**: `http://host.docker.internal:9000` (for Docker access)
- **Project Key**: `docker-mcpai-stack`

### Manual Docker Command

```bash
# Using local configuration
docker run --rm -v "${PWD}:/usr/src" sonarsource/sonar-scanner-cli -Dproject.settings=sonar-project.local.properties

# Using command line parameters
docker run --rm -v "${PWD}:/usr/src" sonarsource/sonar-scanner-cli \
  -Dsonar.projectKey=docker-mcpai-stack \
  -Dsonar.sources=. \
  -Dsonar.host.url=http://host.docker.internal:9000 \
  -Dsonar.token=YOUR_TOKEN_HERE
```

## ‚òÅÔ∏è Online Setup (SonarCloud)

### Prerequisites

1. **SonarCloud Account**: Connected to your GitHub account
2. **GitHub Repository**: With SonarCloud app installed
3. **GitHub Secret**: `SONAR_TOKEN` configured in repository settings

### Configuration

- **File**: `sonar-project.properties`
- **Organization**: `ofayese`
- **Project Key**: `ofayese_docker-mcpai-stack`
- **Trigger**: Automatic on push to `main`/`develop` branches

### GitHub Secrets Setup

1. Go to [SonarCloud.io](https://sonarcloud.io)
2. Navigate to your project ‚Üí Administration ‚Üí Security
3. Generate a new token
4. In GitHub: Repository ‚Üí Settings ‚Üí Secrets and variables ‚Üí Actions
5. Add secret: `SONAR_TOKEN` = `your_generated_token`

## üîß Configuration Files

### `sonar-project.properties` (SonarCloud)

```properties
# SonarCloud Configuration
sonar.projectKey=ofayese_docker-mcpai-stack
sonar.organization=ofayese
sonar.projectName=Docker MCP AI Stack
sonar.projectVersion=1.0.0

# Source configuration
sonar.sources=services,scripts
sonar.tests=tests
sonar.python.coverage.reportPaths=coverage.xml

# Exclusions
sonar.coverage.exclusions=**/*test*/**,**/tests/**,**/__pycache__/**
sonar.exclusions=**/*test*/**,**/tests/**,**/*.log,**/*.md
```

### `sonar-project.local.properties` (Local SonarQube)

```properties
# Local SonarQube Configuration
sonar.projectKey=docker-mcpai-stack
sonar.host.url=http://host.docker.internal:9000
sonar.token=YOUR_LOCAL_TOKEN_HERE

# Same source configuration as above...
```

## üöÄ GitHub Actions Workflow

The SonarCloud analysis runs automatically via GitHub Actions (`.github/workflows/sonarcloud.yml`) on:

- Push to `main` or `develop` branches
- Pull requests to `main` branch

### Manual Trigger (Cross-Platform)

You can also trigger SonarCloud analysis manually using the provided scripts:

```bash
# Linux/macOS
./scripts/sonar-online.sh

# Windows (with bash available)
bash scripts/sonar-online.sh

# Or use Make (cross-platform)
make sonar-online
```

## üìà Viewing Results

### Local SonarQube

- **URL**: <http://localhost:9000>
- **Project**: `docker-mcpai-stack`

### SonarCloud

- **URL**: <https://sonarcloud.io/organizations/ofayese/projects>
- **Project**: `ofayese_docker-mcpai-stack`

## üõ†Ô∏è Troubleshooting

### Docker Connection Issues

```bash
# Check if SonarQube server is accessible
curl http://localhost:9000

# Check Docker connectivity
docker run --rm curlimages/curl curl http://host.docker.internal:9000
```

### Token Issues

- **Local**: Verify token in SonarQube ‚Üí Administration ‚Üí Security ‚Üí Users
- **SonarCloud**: Verify token in SonarCloud ‚Üí My Account ‚Üí Security

### Build Failures

- Check `coverage.xml` is generated by running tests first
- Verify all service dependencies are installed
- Check exclusion patterns in configuration files
